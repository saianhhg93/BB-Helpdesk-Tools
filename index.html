<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BB Helpdesk Tools</title>
    <style>
        html, body { height: 100%; margin: 0; font-family: "Segoe UI", Arial, sans-serif; background-color: #f4f4f4; }
        body { display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .container { max-width: 700px; width: 100%; margin: 20px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .section { border: 1px solid #e0e0e0; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
        .section-title { font-weight: 600; font-size: 1.1em; color: #d9534f; margin-bottom: 15px; display: flex; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .section-title::before { content: 'üìã'; margin-right: 8px; font-size: 1.2em; }
        .button-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; }
        .btn { padding: 10px 15px; border: 1px solid #ccc; background-color: #f8f8f8; border-radius: 4px; cursor: pointer; text-align: left; font-size: 14px; display: flex; align-items: center; transition: background-color 0.2s, border-color 0.2s; }
        .btn:hover { background-color: #e9e9e9; border-color: #999; }
        .btn i { margin-right: 8px; font-style: normal; }
        .path-selector { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .path-selector label { font-weight: 600; min-width: 180px; }
        .path-selector input[type="text"] { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; min-width: 250px; }
        .path-selector button { padding: 8px 15px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 4px; cursor: pointer; }
        .path-selector button:hover { background-color: #e0e0e0; }
        .swal-title-custom { font-family: "Segoe UI", Arial, sans-serif !important; font-weight: 600; }
        .bd-node{display:flex;align-items:center;gap:8px;margin:4px 0;}
        .bd-node > .bd-toggle{border:1px solid #ddd;background:#f8f9fa;border-radius:4px;padding:0 4px;cursor:pointer}
        .bd-node > .bd-spacer{display:inline-block;width:18px}
        .bd-name{font-weight:600}
        .meta{color:#666;font-size:12px}
        /* ===== Tree View (Windows-like) ===== */
        .tree { font-size:14px; line-height:1.35; }
        .tree ul { list-style:none; margin:0; padding-left:20px; position:relative; }
        .tree ul::before {
          content:""; position:absolute; top:0; bottom:0; left:8px; width:1px; background:#e5e7eb;
        }
        .tree li { position:relative; margin:2px 0 2px 0; padding-left:20px; }
        .tree li::before {
          content:""; position:absolute; top:0.9em; left:8px; width:12px; height:1px; background:#e5e7eb;
        }
        .tree .row { display:flex; align-items:center; gap:6px; }
        .tree .toggle {
          width:16px; height:16px; border:1px solid #d0d5dd; background:#f8fafc; border-radius:3px;
          font-size:12px; line-height:14px; text-align:center; cursor:pointer; user-select:none;
        }
        .tree .toggle[aria-expanded="true"] { background:#eef2ff; }
        .tree .name { font-weight:600; }
        .tree .meta { color:#666; font-size:12px; margin-left:4px; }
        .tree .muted{ color:#999; }
        .tree .leaf .toggle { visibility:hidden; } /* file: kh√¥ng c√≥ n√∫t toggle */
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=memory" />
</head>
<body>
<div class="container">
    <div class="section">
        <div class="section-title">H·ªá th·ªëng</div>
        <div class="button-grid">
            <button class="btn" id="check-info-btn"><i>üìÑ</i> Check th√¥ng tin m√°y</button>
            <button class="btn" id="settings-btn"><i>ü™ü</i> Thi·∫øt l·∫≠p Windows</button>
            <button class="btn" id="network-settings-btn"><i>üåê</i> Thi·∫øt l·∫≠p m·∫°ng</button>
            <button class="btn" id="bloatware-btn"><i>üóëÔ∏è</i> X√≥a Bloatware</button>
            <button class="btn" id="bitlocker-btn"><i>üîí</i> T·∫Øt Bitlocker</button>
            <button class="btn" id="activation-btn"><i>üîë</i> K√≠ch ho·∫°t Win - Office</button>
        </div>
    </div>
    <div class="section">
        <div class="section-title" style="color: #c9302c;">Sao l∆∞u - Kh√¥i ph·ª•c</div>
        <div class="path-selector"> <label for="backup-folder">Th∆∞ m·ª•c sao l∆∞u backup:</label> <input type="text" id="backup-folder" value="D:\BB_Backup"> <button id="select-backup-btn">Ch·ªçn</button> </div>
        <div class="button-grid"> 
            <button class="btn" id="backup-wifi-btn"><i>üì°</i> Sao l∆∞u Wifi</button>
            <button class="btn" id="backup-drivers-btn"><i>üíª</i> Sao l∆∞u Driver</button>
            <button class="btn" id="backup-data-btn"><i>üíæ</i> Sao l∆∞u D·ªØ li·ªáu</button>
            <button class="btn" id="backup-zalo-btn"><i>üí¨</i> Sao l∆∞u Zalo</button>
            <button class="btn" id="backup-registry-btn"><i>üóÑÔ∏è</i> Sao l∆∞u Registry</button>
            <button class="btn" id="restore-data-btn"><i>üîÑ</i> Kh√¥i ph·ª•c d·ªØ li·ªáu</button>
        </div>
    </div>
</div>

<script>
  (async () => {
    try {
      const current = await window.electronAPI.getBackupDir();
      const input = document.getElementById('backup-folder');
      if (current && input) input.value = current;
    } catch {}
  })();

  // Khi ng∆∞·ªùi d√πng b·∫•m "Ch·ªçn", c·∫≠p nh·∫≠t input v√† l∆∞u l·∫°i v·ªÅ main process
  document.getElementById('select-backup-btn').addEventListener('click', async () => {
    const filePath = await window.electronAPI.openDirectory();
    if (filePath) {
      document.getElementById('backup-folder').value = filePath;
      window.electronAPI.setBackupDir(filePath); // <-- th√™m d√≤ng n√†y
    }
  });

  // (tu·ª≥ ch·ªçn) n·∫øu m·ªôt c·ª≠a s·ªï kh√°c ƒë·ªïi backupDir, input t·ª± c·∫≠p nh·∫≠t theo
  window.electronAPI.onBackupDirUpdated((dir) => {
    const input = document.getElementById('backup-folder');
    if (input) input.value = dir;
  });


    document.getElementById('check-info-btn').addEventListener('click', async () => {
        Swal.fire({ title: 'ƒêang thu th·∫≠p th√¥ng tin...', text: 'Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t.', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
        try {
            const jsonString = await window.electronAPI.getSystemInfo();
            const info = JSON.parse(jsonString);
            
            // B·ªè 'max-height' v√† 'overflow-y' ƒë·ªÉ h·ªôp tho·∫°i t·ª± gi√£n ra
            const contentHtml = `
                <div style="text-align: left; font-family: monospace; font-size: 14px; padding: 10px; border: 1px solid #eee; border-radius: 5px;">
                    <b>‚öôÔ∏è VI X·ª¨ L√ù (CPU)</b><br> - T√™n: ${info.cpu.Name}<br> - Socket: ${info.cpu.Socket} (${info.cpu.SocketDesignation})<br> - L√µi: ${info.cpu.Cores}<br> - Lu·ªìng: ${info.cpu.Threads}<br> <hr>
                    <b>üîå BO M·∫†CH CH·ª¶ (Motherboard)</b><br> - T√™n: ${info.motherboard.Model}<br> - Version: ${info.motherboard.Version}<br> - SerialNumber: ${info.motherboard.SerialNumber}<br> - BIOS Version: ${info.motherboard.BiosVersion} (Ph√°t h√†nh: ${info.motherboard.BiosReleaseDate})<br> <hr>
                    <b>üíæ B·ªò NH·ªö (Memory)</b><br> - Khe c·∫Øm ƒë√£ d√πng: ${info.memory.UsedSlots} / ${info.memory.TotalSlots}<br> ${info.memory.Sticks.map((stick, index) => `&nbsp;&nbsp;[Thanh ${index + 1}] ${stick.Size}GB ${stick.Type}, ${stick.ModuleManuf}, ${stick.PartNumber}, Speed: ${stick.Speed}MHz`).join('<br>')} <br><hr>
                    <b>üé® CARD ƒê·ªí H·ªåA (GPU)</b><br> ${info.gpu.map(g => `- ${g.Name}`).join('<br>')}<br> <hr>
                    <b>üíø ·ªî ƒêƒ®A (Drives)</b><br> ${info.drives.map(d => `- ${d.Model} - ${d.Size}GB (${d.Interface})`).join('<br>')}<br> <hr>
                    <b>üìÄ H·ªÜ ƒêI·ªÄU H√ÄNH</b><br> - T√™n: ${info.os.Name}<br> - Phi√™n b·∫£n: ${info.os.Version}<br> <hr>
                    <b>üåê CARD M·∫†NG (Ch·ªâ card v·∫≠t l√Ω)</b><br>
                    ${info.network.map(n => `
                        - ${n.Name} (${n.MacAddress || 'N/A'})<br>
                        &nbsp;&nbsp;Status: ${n.Status} | Speed: ${n.LinkSpeed} Mbps<br>
                        &nbsp;&nbsp;IPv4: ${n.IPv4 || 'N/A'}<br>
                        &nbsp;&nbsp;Gateway: ${n.Gateway || 'N/A'}<br>
                        &nbsp;&nbsp;DNS Servers: ${n.DNSServers || 'N/A'}
                    `).join('<br><br>')}
                </div>
            `;

            Swal.fire({
                customClass: { title: 'swal-title-custom' },
                title: '<strong>Th√¥ng Tin H·ªá Th·ªëng</strong>',
                icon: 'info',
                html: contentHtml,
                width: '700px'
            })

        } catch (error) {
            Swal.fire({ icon: 'error', title: 'Oops...', text: 'ƒê√£ x·∫£y ra l·ªói khi l·∫•y th√¥ng tin h·ªá th·ªëng!' })
                .then(() => {
                    window.electronAPI.resizeWindow(originalSize);
                });
            console.error(error);
        }
    });
    document.getElementById('settings-btn').addEventListener('click', () => {
        window.electronAPI.openSettingsWindow();
    });

    document.getElementById('network-settings-btn').addEventListener('click', () => {
    window.electronAPI.openNetworkWindow();
    });
    
    document.getElementById('bloatware-btn').addEventListener('click', () => {
    window.electronAPI.openBloatwareWindow();
    });
    document.getElementById('bitlocker-btn').addEventListener('click', () => {
    window.electronAPI.openBitLockerWindow();
    });
    document.getElementById('activation-btn').addEventListener('click', () => {
    window.electronAPI.openActivationWindow();
    });

          // Helper: ƒë·∫£m b·∫£o c√≥ th∆∞ m·ª•c backup hi·ªán t·∫°i
  function ensureBackupDir() {
    const v = document.getElementById('backup-folder')?.value?.trim();
    if (!v) {
      Swal.fire('Thi·∫øu th∆∞ m·ª•c sao l∆∞u','H√£y ch·ªçn "Th∆∞ m·ª•c sao l∆∞u backup" tr∆∞·ªõc.','warning');
      return null;
    }
    return v;
  }

  // === Sao l∆∞u Wi-Fi ===
document.getElementById('backup-wifi-btn').addEventListener('click', async () => {
  try {
    Swal.fire({ title: 'ƒêang ƒë·ªçc danh s√°ch Wi-Fi...', allowOutsideClick:false, didOpen: () => Swal.showLoading() });
    const res = await window.electronAPI.listWifiProfiles();
    if (!res?.success) { Swal.fire('L·ªói', res?.message || 'Kh√¥ng th·ªÉ l·∫•y danh s√°ch Wi-Fi.', 'error'); return; }

    // √âP V·ªÄ M·∫¢NG k·ªÉ c·∫£ khi PowerShell tr·∫£ 1 object
    const raw   = JSON.parse(res.data || '[]');
    const items = Array.isArray(raw) ? raw : (raw ? [raw] : []);
    if (!items.length) { Swal.fire('Th√¥ng b√°o','Kh√¥ng t√¨m th·∫•y profile Wi-Fi n√†o.','info'); return; }


      // Render danh s√°ch tick ch·ªçn
      const htmlList = items.map((x, idx) => {
        const pwd = x.Password ? `<code>${x.Password}</code>` : '<i style="color:#999">kh√¥ng ƒë·ªçc ƒë∆∞·ª£c</i>';
        const sec = [x.Authentication, x.Cipher].filter(Boolean).join(' | ');
        return `
          <label style="display:flex;gap:10px;align-items:flex-start;margin:6px 0;">
            <input type="checkbox" class="wifi-item" data-name="${x.Name.replace(/"/g,'&quot;')}" checked>
            <div style="line-height:1.35">
              <div><b>${x.SSID || x.Name}</b> <span style="color:#999;">(${x.Name})</span></div>
              <div>M·∫≠t kh·∫©u: ${pwd}</div>
              ${sec ? `<div style="color:#555">${sec}</div>` : ''}
            </div>
          </label>
        `;
      }).join('');

      const swalHtml = `
        <div style="text-align:left;max-height:60vh;overflow:auto;">
          <div style="margin-bottom:8px;">
            <button id="wifi-select-all"  class="swal2-confirm swal2-styled" style="background:#6c757d;margin-right:8px;">Ch·ªçn t·∫•t c·∫£</button>
            <button id="wifi-unselect-all" class="swal2-deny swal2-styled"    style="background:#adb5bd;">B·ªè ch·ªçn</button>
          </div>
          ${htmlList}
        </div>
      `;

      await Swal.fire({
        title: 'Sao l∆∞u Wi‚ÄëFi ƒë√£ l∆∞u',
        html: swalHtml,
        width: '720px',
        showCancelButton: true,
        confirmButtonText: 'Sao l∆∞u c√°c m·∫°ng ƒë√£ ch·ªçn',
        cancelButtonText: 'ƒê√≥ng',
        didOpen: () => {
          const $ = (sel) => Swal.getHtmlContainer().querySelector(sel);
          $('#wifi-select-all').addEventListener('click', () => {
            Swal.getHtmlContainer().querySelectorAll('.wifi-item').forEach(cb => cb.checked = true);
          });
          $('#wifi-unselect-all').addEventListener('click', () => {
            Swal.getHtmlContainer().querySelectorAll('.wifi-item').forEach(cb => cb.checked = false);
          });
        },
        preConfirm: () => {
          const boxes = Swal.getHtmlContainer().querySelectorAll('.wifi-item:checked');
          const picked = Array.from(boxes).map(cb => cb.getAttribute('data-name'));
          if (picked.length === 0) {
            Swal.showValidationMessage('H√£y ch·ªçn √≠t nh·∫•t 1 m·∫°ng Wi‚ÄëFi ƒë·ªÉ sao l∆∞u.');
            return false;
          }
          return picked;
        }
      }).then(async (ret) => {
        if (!ret.isConfirmed) return;
        const names = ret.value || [];
        const outBase = ensureBackupDir();
        if (!outBase) return;

        Swal.fire({ title: 'ƒêang sao l∆∞u...', allowOutsideClick:false, didOpen: () => Swal.showLoading() });
        const r2 = await window.electronAPI.backupWifiProfiles({ names, outputDir: outBase });
if (!r2?.success) { Swal.fire('L·ªói', r2?.message || 'Sao l∆∞u th·∫•t b·∫°i.', 'error'); return; }

    const html = `
        <div style="text-align:left">
        <div><b>T·ªáp ZIP:</b> <code>${r2.ZipFile}</code></div>
        </div>
    `;
Swal.fire({ icon:'success', title:'Ho√†n t·∫•t!', html, width:'700px' });
      });

  } catch (e) {
    console.error(e);
    Swal.fire('L·ªói','ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.','error');
  }
});

      // === Sao l∆∞u Driver ===
      function ensureBackupDir(){
    const v = document.getElementById('backup-folder')?.value?.trim();
    if(!v){ Swal.fire('Thi·∫øu th∆∞ m·ª•c sao l∆∞u','H√£y ch·ªçn "Th∆∞ m·ª•c sao l∆∞u backup" tr∆∞·ªõc.','warning'); return null; }
    return v;
  }

  document.getElementById('backup-drivers-btn').addEventListener('click', async () => {
    try{
      Swal.fire({ title:'ƒêang ƒë·ªçc danh s√°ch driver...', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });
      const res = await window.electronAPI.listDrivers();
      if(!res?.success){ Swal.fire('L·ªói', res?.message || 'Kh√¥ng l·∫•y ƒë∆∞·ª£c danh s√°ch driver.', 'error'); return; }
      const items = JSON.parse(res.data || '[]'); // [{PublishedName,ProviderName,ClassName,Date,Version,Inbox,Recommended}]
      if(!Array.isArray(items) || items.length===0){ Swal.fire('Th√¥ng b√°o','Kh√¥ng t√¨m th·∫•y driver n√†o.', 'info'); return; }

      // Render list: ∆∞u ti√™n Recommended, c√≥ nh√£n "Khuy·∫øn ngh·ªã"
    const htmlList = items.map(x=>{
  const canExport = !!x.PublishedName;
  const badge = (x.Recommended && !x.ProviderIsMicrosoft && !x.Inbox)
    ? `<span style="background:#ffe8a1;color:#7a5b00;border:1px solid #f0d58a;border-radius:6px;padding:2px 6px;margin-left:6px;font-size:12px;">Khuy·∫øn ngh·ªã</span>`
    : '';
  const ver = [x.Date, x.Version].filter(Boolean).join(' ‚Äî ');
  const sec = [x.ClassName, x.ProviderName].filter(Boolean).join(' ‚Ä¢ ');
  const note = x.Inbox ? 'Inbox: C√≥ s·∫µn trong Windows'
                       : (x.ProviderIsMicrosoft ? 'Microsoft driver'
                                                : 'Third-party (kh√¥ng c√≥ s·∫µn)');
  const disabled = canExport ? '' : 'disabled';
  const titleDis = canExport ? '' : 'title="Thi·∫øu t√™n INF n√™n kh√¥ng th·ªÉ xu·∫•t t·ª± ƒë·ªông"';

  return `
    <label style="display:flex;gap:10px;align-items:flex-start;margin:6px 0;${canExport?'':'opacity:.7'}">
      <input type="checkbox" class="drv-item" data-pn="${(x.PublishedName||'').replace(/"/g,'&quot;')}" ${x.Recommended&&!x.ProviderIsMicrosoft&&!x.Inbox?'checked':''} ${disabled} ${titleDis}>
      <div style="line-height:1.35">
        <div><b>${x.DeviceName || x.PublishedName || '(Kh√¥ng r√µ t√™n thi·∫øt b·ªã)'}</b> ${badge}</div>
        ${x.PublishedName ? `<div style="color:#888">INF: ${x.PublishedName}</div>` : `<div style="color:#888"><i>Kh√¥ng c√≥ INF</i></div>`}
        ${ver? `<div>${ver}</div>`:''}
        ${sec? `<div style="color:#666">${sec}</div>`:''}
        <div style="color:#999">${note}</div>
      </div>
    </label>
  `;
}).join('');

      const swalHtml = `
        <div style="text-align:left;max-height:60vh;overflow:auto;">
          <div style="margin-bottom:8px;display:flex;gap:8px;flex-wrap:wrap;">
            <button id="drv-select-all" class="swal2-confirm swal2-styled" style="background:#6c757d;">Ch·ªçn t·∫•t c·∫£</button>
            <button id="drv-unselect-all" class="swal2-deny swal2-styled" style="background:#adb5bd;">B·ªè ch·ªçn</button>
            <button id="drv-select-reco" class="swal2-confirm swal2-styled" style="background:#f59e0b;">Ch·ªâ ch·ªçn Khuy·∫øn ngh·ªã</button>
          </div>
          ${htmlList}
        </div>
      `;

      await Swal.fire({
        title:'Sao l∆∞u Driver ƒë√£ c√†i',
        html: swalHtml,
        width:'820px',
        showCancelButton:true,
        confirmButtonText:'Sao l∆∞u c√°c driver ƒë√£ ch·ªçn',
        cancelButtonText:'ƒê√≥ng',
        didOpen: ()=>{
          const $ = (s)=>Swal.getHtmlContainer().querySelector(s);
          $('#drv-select-all').addEventListener('click', ()=>Swal.getHtmlContainer().querySelectorAll('.drv-item').forEach(cb=>cb.checked=true));
          $('#drv-unselect-all').addEventListener('click', ()=>Swal.getHtmlContainer().querySelectorAll('.drv-item').forEach(cb=>cb.checked=false));
          $('#drv-select-reco').addEventListener('click', ()=>{
            Swal.getHtmlContainer().querySelectorAll('.drv-item').forEach(cb=>{
              const label = cb.closest('label');
              const hasReco = label?.querySelector('span')?.textContent?.includes('Khuy·∫øn ngh·ªã');
              cb.checked = !!hasReco;
            });
          });
        },
        preConfirm: ()=>{
          const boxes = Swal.getHtmlContainer().querySelectorAll('.drv-item:checked');
          const picked = Array.from(boxes).map(cb=>cb.getAttribute('data-pn')).filter(Boolean);
          if(picked.length===0){
            Swal.showValidationMessage('H√£y ch·ªçn √≠t nh·∫•t 1 driver.');
            return false;
          }
          return picked;
        }
      }).then(async (ret)=>{
        if(!ret.isConfirmed) return;
        const publishedNames = ret.value || [];
        const outBase = ensureBackupDir(); if(!outBase) return;

        Swal.fire({ title:'ƒêang sao l∆∞u driver...', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });
        const r2 = await window.electronAPI.backupDrivers({ publishedNames, outputDir: outBase });
        if(!r2?.success){ Swal.fire('L·ªói', r2?.message || 'Sao l∆∞u th·∫•t b·∫°i.', 'error'); return; }
        const html = `<div style="text-align:left"><div><b>T·ªáp ZIP:</b> <code>${r2.ZipFile}</code></div></div>`;
        Swal.fire({ icon:'success', title:'Ho√†n t·∫•t!', html, width:'700px' });
      });

    }catch(err){
      console.error(err);
      Swal.fire('L·ªói','ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.','error');
    }
  });

      // === Sao l∆∞u D·ªØ li·ªáu ===
// helper th∆∞ m·ª•c backup ƒëang c√≥ s·∫µn
function ensureBackupDir(){
  const v = document.getElementById('backup-folder')?.value?.trim();
  if(!v){ Swal.fire('Thi·∫øu th∆∞ m·ª•c sao l∆∞u','H√£y ch·ªçn "Th∆∞ m·ª•c sao l∆∞u backup" tr∆∞·ªõc.','warning'); return null; }
  return v;
}

// Format dung l∆∞·ª£ng (tu·ª≥ ch·ªçn)
function fmtBytes(n){
  if(n==null || isNaN(n)) return '';
  const u=['B','KB','MB','GB','TB']; let i=0; let v=Number(n);
  while(v>=1024 && i<u.length-1){ v/=1024; i++; }
  return v.toFixed(v<10?2:0)+' '+u[i];
}

document.getElementById('backup-data-btn').addEventListener('click', async () => {
  try {
    Swal.fire({ title: 'ƒêang chu·∫©n b·ªã...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

    const rootsRes = await window.electronAPI.getBackupDataRoots();
    if (!rootsRes?.success) { Swal.fire('L·ªói', rootsRes?.message || 'Kh√¥ng l·∫•y ƒë∆∞·ª£c danh s√°ch th∆∞ m·ª•c g·ªëc.', 'error'); return; }
    const roots = JSON.parse(rootsRes.data || '[]');

    // X√¢y UI 2 c·ªôt
    const leftItems = (grp) => roots.filter(r => r.Group === grp).map(r => `
      <div class="bd-root" data-path="${r.Path.replace(/"/g,'&quot;')}" data-key="${r.Key}">
        <input type="radio" name="bd-root" id="bd-${r.Key}">
        <label for="bd-${r.Key}">
          <div class="title">${r.Label}</div>
          ${r.Note ? `<div class="note">${r.Note}</div>` : ''}
          <div class="path">${r.Path}</div>
        </label>
      </div>
    `).join('');

    const swalHtml = `
      <style>
        .bd-wrap{display:grid;grid-template-columns:240px 1fr;gap:12px;min-height:420px;}
        .bd-right{width:auto;max-width:none!important;min-width:0;overflow-x:hidden!important;white-space:normal!important;box-sizing:border-box;}
        #bd-list,#bd-list .tree,#bd-list .tree ul{width:100%;white-space:normal!important;}
        .tree .row{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
        .tree .name,.tree .meta{max-width:100%;overflow-wrap:anywhere;word-break:break-word;}
        .bd-col{padding:10px;}
        .bd-head{font-weight:600;margin:4px 0 8px;}
        .bd-sec{border-top:1px dashed #e5e7eb;padding-top:8px;margin-top:8px;}
        .bd-root{border:1px solid #eee;border-radius:8px;padding:8px;margin:6px 0;}
        .bd-root .title{font-weight:600}
        .bd-root .note{color:#7a5b00;background:#fff4ce;display:inline-block;padding:0 6px;border-radius:6px;border:1px solid #f0d58a;margin:4px 0;}
        .bd-root .path{color:#888;font-size:12px}
        .bd-right .tools{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;flex-wrap:wrap}
        .bd-item{display:flex;gap:10px;align-items:flex-start;margin:6px 0}
        .bd-item .meta{color:#666;font-size:12px}
        .muted{color:#999}
        .bd-right .tools .counter{color:#444;font-size:13px;white-space:nowrap;}
      </style>
      <div class="bd-wrap">
        <div class="bd-col bd-left">
          <div class="bd-head">C∆° b·∫£n</div>
          ${leftItems('basic')}
          <div class="bd-sec"></div>
          <div class="bd-head">N√¢ng cao</div>
          ${leftItems('advanced')}
        </div>
        <div class="bd-col bd-right">
          <div class="tools">
            <div class="btns">
              <button id="bd-select-all"  class="swal2-confirm swal2-styled" style="background:#6c757d">Ch·ªçn t·∫•t c·∫£</button>
              <button id="bd-unselect-all" class="swal2-deny swal2-styled"    style="background:#adb5bd">B·ªè ch·ªçn</button>
            </div>
            <div id="bd-counter" class="counter">Ch∆∞a ch·ªçn m·ª•c n√†o</div>
          </div>
          <div id="bd-list" class="muted">H√£y ch·ªçn 1 m·ª•c ·ªü c·ªôt b√™n tr√°i ƒë·ªÉ li·ªát k√™ th∆∞ m·ª•c/file con‚Ä¶</div>
        </div>
      </div>
    `;

    // === M·ªû POPUP & THI·∫æT L·∫¨P C√ÇY ===
    const ret = await Swal.fire({
      title: 'Sao l∆∞u d·ªØ li·ªáu',
      html: swalHtml,
      width: '960px',
      showCancelButton: true,
      confirmButtonText: 'B·∫Øt ƒë·∫ßu sao l∆∞u',
      cancelButtonText: 'ƒê√≥ng',

      didOpen: () => {
        const $  = (s) => Swal.getHtmlContainer().querySelector(s);
        const $$ = (s) => Swal.getHtmlContainer().querySelectorAll(s);

        function updateCounter(){
          const boxes = Swal.getHtmlContainer().querySelectorAll('#bd-list input.pick:checked');
          let files = 0, dirs = 0;
          boxes.forEach(cb => {
            const li = cb.closest('li');
            (li?.getAttribute('data-type') === 'dir') ? dirs++ : files++;
          });
          const total = files + dirs;
          $('#bd-counter').textContent = total ? `ƒê√£ ch·ªçn: ${total} (th∆∞ m·ª•c: ${dirs}, file: ${files})` : 'Ch∆∞a ch·ªçn m·ª•c n√†o';
        }

        function nodeHTML(item){
          const isDir = item.Type === 'dir';
          const sizeMeta = isDir ? '(th∆∞ m·ª•c)' : `(file${item.Size ? ', ' + fmtBytes(item.Size) : ''})`;
          return `
            <li class="${isDir ? 'branch' : 'leaf'}" data-path="${item.FullPath.replace(/"/g,'&quot;')}" data-type="${item.Type}">
              <div class="row">
                <div class="toggle" aria-expanded="false">${isDir ? '‚ñ∂' : ''}</div>
                <input type="checkbox" class="pick">
                <span class="name">${item.Name}</span>
                <span class="meta"> ${sizeMeta}</span>
              </div>
              <ul class="children" style="display:none;"></ul>
            </li>
          `;
        }

        async function loadChildrenInto(ulElem, fullPath){
          ulElem.innerHTML = `<li class="muted" style="padding-left:0">ƒêang t·∫£i...</li>`;
          const r = await window.electronAPI.listBackupChildren({ path: fullPath });
          if (!r || !r.success) { ulElem.innerHTML = `<li class="muted" style="padding-left:0">Kh√¥ng th·ªÉ li·ªát k√™ n·ªôi dung.</li>`; return; }
          const items = JSON.parse(r.data || '[]');
          ulElem.innerHTML = (Array.isArray(items) && items.length)
            ? items.map(nodeHTML).join('')
            : `<li class="muted" style="padding-left:0">Tr·ªëng.</li>`;
          updateCounter();
        }

        function cascadeDown(li, checked){
          li.querySelectorAll(':scope > ul.children input.pick').forEach(cb => cb.checked = checked);
          li.querySelectorAll(':scope > ul.children > li').forEach(child => cascadeDown(child, checked));
        }
        function cascadeUp(li){
          const parent = li.parentElement?.closest('li'); if (!parent) return;
          const cbs = parent.querySelectorAll(':scope > ul.children input.pick');
          if (cbs.length){
            const checked = Array.from(cbs).filter(x => x.checked).length;
            const pcb = parent.querySelector(':scope > .row > input.pick');
            if (pcb){
              pcb.indeterminate = checked > 0 && checked < cbs.length;
              pcb.checked = checked === cbs.length;
            }
          }
          cascadeUp(parent);
        }

        async function renderRoot(rootPath){
          const list = $('#bd-list');
          list.classList.remove('muted');
          list.innerHTML = `<div class="tree"><ul class="root"></ul></div>`;
          const rootUL = list.querySelector('.root');
          await loadChildrenInto(rootUL, rootPath);

          list.addEventListener('click', async (e) => {
            const btn = e.target.closest('.toggle'); if (!btn) return;
            const li = btn.closest('li'); if (li.classList.contains('leaf')) return;
            const children = li.querySelector(':scope > ul.children');
            const expanded = btn.getAttribute('aria-expanded') === 'true';
            if (expanded){
              children.style.display = 'none';
              btn.setAttribute('aria-expanded','false'); btn.textContent = '‚ñ∂';
            } else {
              if (!children.dataset.loaded){
                await loadChildrenInto(children, li.getAttribute('data-path'));
                children.dataset.loaded = '1';
              }
              children.style.display = 'block';
              btn.setAttribute('aria-expanded','true'); btn.textContent = '‚ñº';
            }
          });

          list.addEventListener('change', (e) => {
            const cb = e.target.closest('input.pick'); if (!cb) return;
            const li = cb.closest('li');
            cascadeDown(li, cb.checked); cascadeUp(li); updateCounter();
          });
        }

        // Tools
        $('#bd-select-all').addEventListener('click', () => { $$('#bd-list input.pick').forEach(cb => cb.checked = true); updateCounter(); });
        $('#bd-unselect-all').addEventListener('click', () => { $$('#bd-list input.pick').forEach(cb => cb.checked = false); updateCounter(); });

        // Ch·ªçn root ·ªü c·ªôt tr√°i
        $$('.bd-root input[type="radio"]').forEach(radio => {
          radio.addEventListener('change', e => {
            const root = e.target.closest('.bd-root').getAttribute('data-path');
            renderRoot(root);
          });
        });

        // Auto ch·ªçn m·ª•c ƒë·∫ßu ti√™n
        const first = $$('.bd-root input[type="radio"]')[0];
        if (first){ first.checked = true; first.dispatchEvent(new Event('change')); }
      },

      // >>> Tr·∫£ c·∫£ picked + rootName ƒë·ªÉ main d√πng ƒë·∫∑t t√™n ZIP
      preConfirm: () => {
        const container = Swal.getHtmlContainer();
        const boxes = container.querySelectorAll('#bd-list input.pick:checked');
        const picked = Array.from(boxes).map(cb => cb.closest('li').getAttribute('data-path'));
        if (picked.length === 0) {
          Swal.showValidationMessage('H√£y ch·ªçn √≠t nh·∫•t 1 th∆∞ m·ª•c ho·∫∑c file.');
          return false;
        }

        // l·∫•y t√™n m·ª•c g·ªëc ƒëang ch·ªçn ·ªü c·ªôt tr√°i
        const rootEl = container.querySelector('.bd-root input[type="radio"]:checked')?.closest('.bd-root');
        const rootName = (
          rootEl?.querySelector('.title')?.textContent ||
          rootEl?.getAttribute('data-key') ||
          'Data'
        ).trim();

        console.log('[backup-data] picked count =', picked.length, picked, 'rootName =', rootName);
        return { picked, rootName };
      }
    });

    if (!ret.isConfirmed) return;

    const outBase  = ensureBackupDir();
    if (!outBase) return;

    const toBackup = (ret.value?.picked) || [];
    const rootName = (ret.value?.rootName) || 'Data';

    Swal.fire({ title: 'ƒêang sao l∆∞u...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

// G·ªåI IPC ‚Äì g·ª≠i k√®m rootName ƒë·ªÉ main ƒë·∫∑t t√™n ZIP: <rootName>-yyyyMMdd-HHmmss.zip
const r2 = await window.electronAPI.backupData({ paths: toBackup, outputDir: outBase, rootName });

// log ƒë·ªÉ b·∫°n xem ‚Äúshape‚Äù th·ª±c s·ª±
console.log('[backup-data] IPC RAW =', r2);

// N·∫øu fail r√µ r√†ng th√¨ b√°o l·ªói
if (!r2 || !r2.success) {
  Swal.fire('L·ªói', (r2 && r2.message) ? r2.message : 'Sao l∆∞u th·∫•t b·∫°i.', 'error');
  return;
}

// ---- helpers hi·ªÉn th·ªã ----
const escapeHtml = (s) => String(s)
  .replace(/&/g,'&amp;').replace(/</g,'&lt;')
  .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
  .replace(/'/g,'&#39;');

function normalizeResults(r, fallbackName) {
  // 1) Chu·∫©n: results l√† array object
  if (Array.isArray(r?.results)) return r.results;

  // 2) data l√† array
  if (Array.isArray(r?.data)) return r.data;

  // 3) C√≥ ZipFile / zipFile ·ªü c·∫•p 1
  if (r?.ZipFile || r?.zipFile) {
    return [{ Name: fallbackName, ZipFile: r.ZipFile || r.zipFile }];
  }

  // 4) data l√† string path
  if (typeof r?.data === 'string' && r.data.trim()) {
    return [{ Name: fallbackName, ZipFile: r.data.trim() }];
  }

  // 5) r l√† string path
  if (typeof r === 'string' && r.trim()) {
    return [{ Name: fallbackName, ZipFile: r.trim() }];
  }

  // 6) r l√† array string
  if (Array.isArray(r) && r.every(x => typeof x === 'string')) {
    return r.map(p => ({ Name: fallbackName, ZipFile: p }));
  }

  // 7) object ƒë∆°n c√≥ Name/ZipFile
  if (r && typeof r === 'object' && (r.Name || r.ZipFile || r.zipFile)) {
    return [{ Name: r.Name || fallbackName, ZipFile: r.ZipFile || r.zipFile || null }];
  }

  return [];
}

// Chu·∫©n ho√° k·∫øt qu·∫£
const results = normalizeResults(r2, rootName || 'Data');
const ok   = results.filter(x => x && x.ZipFile);
const fail = results.filter(x => !x || !x.ZipFile);

let html = '';
if (ok.length) {
  html += `<div style="text-align:left;margin-bottom:8px">
             <b>ƒê√£ t·∫°o:</b> <code style="font-size:16px">${ok[0].ZipFile}</code>
           </div>`;
}
if (fail.length) {
  html += `<div style="text-align:left;margin-top:12px;color:#b91c1c">
             <b>L·ªói:</b> ${fail.map(x => x.Error || 'Kh√¥ng r√µ').join(', ')}
           </div>`;
}
if (!html) html = `<div style="text-align:left"><i>Kh√¥ng c√≥ t·ªáp n√†o ƒë∆∞·ª£c t·∫°o.</i></div>`;
Swal.fire({ icon:'success', title:'Ho√†n t·∫•t!', html, width:'720px' });

  } catch (err) {
    console.error(err);
    Swal.fire('L·ªói', 'ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.', 'error');
  }
});


// === Sao l∆∞u Zalo ===
  document.getElementById('backup-zalo-btn').addEventListener('click', async () => {
  const outBase = ensureBackupDir();
  if (!outBase) return;

  const conf = await Swal.fire({
    title: 'Sao l∆∞u Zalo?',
    text: 'Sao l∆∞u to√†n b·ªô th∆∞ m·ª•c "Zalo Received Files" trong Documents v√† n√©n th√†nh m·ªôt t·ªáp.',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'C√≥',
    cancelButtonText: 'Kh√¥ng'
  });
  if (!conf.isConfirmed) return;

  try {
    Swal.fire({ title:'ƒêang sao l∆∞u...', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });

    const r2 = await window.electronAPI.backupZalo({ outputDir: outBase });

    if (!r2 || !r2.success) {
      Swal.fire('L·ªói', (r2 && r2.message) ? r2.message : 'Sao l∆∞u th·∫•t b·∫°i.', 'error');
      return;
    }

    // chu·∫©n ho√° (ph√≤ng khi handler tr·∫£ ki·ªÉu kh√°c)
    let results = Array.isArray(r2.results) ? r2.results : [];
    if (!results.length && r2.ZipFile) results = [{ ZipFile: r2.ZipFile }];

    const ok   = results.filter(x => x && x.ZipFile);
    const fail = results.filter(x => !x || !x.ZipFile);

    let html = '';
    if (ok.length) {
      // m·ªôt d√≤ng, c√πng k√≠ch c·ª° ch·ªØ
      html += `<div style="text-align:left;margin-bottom:8px"><b>ƒê√£ t·∫°o:</b> <code style="font-size:14px">${ok[0].ZipFile}</code></div>`;
    }
    if (fail.length) {
      html += `<div style="text-align:left;color:#b91c1c"><b>L·ªói:</b> ${fail.map(x => x.Error || 'Kh√¥ng r√µ').join(', ')}</div>`;
    }
    if (!html) {
      html = `<div style="text-align:left"><i>Kh√¥ng c√≥ t·ªáp n√†o ƒë∆∞·ª£c t·∫°o.</i></div>`;
    }

    Swal.fire({ icon:'success', title:'Ho√†n t·∫•t!', html, width:'720px' });
  } catch (err) {
    console.error(err);
    Swal.fire('L·ªói', 'ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.', 'error');
  }
});

// === Sao l∆∞u Registry ===
document.getElementById('backup-registry-btn').addEventListener('click', async () => {
  const outBase = ensureBackupDir();
  if (!outBase) return;

  try {
    const list = await window.electronAPI.registryList();
    const soft = (list?.data?.Software || []).slice(0, 500);
    const cps  = (list?.data?.ControlPanel || []);

    const basic = [
      { key:'hkcu_software',      label:'C√†i ƒë·∫∑t Ph·∫ßn m·ªÅm (HKCU\\Software)', desc:'L∆∞u c·∫•u h√¨nh ng∆∞·ªùi d√πng cho ph·∫ßn m·ªÅm.' },
      { key:'hkcu_control_panel', label:'T√πy ch·ªânh c√° nh√¢n (HKCU\\Control Panel)', desc:'Chu·ªôt, b√†n ph√≠m, m√†n h√¨nh, giao di·ªán‚Ä¶' },
    ];

    const renderList = () => `
      <style>
        .grp{border:1px solid #eee;border-radius:8px;padding:8px;margin:10px 0}
        .title{font-weight:700;margin-bottom:6px}
        .cols{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.25rem}
        .item{display:flex;align-items:center;gap:.5rem;padding:4px 6px}
        .item input{margin:0}
        @media (max-width:720px){ .cols{grid-template-columns:1fr} }
      </style>
      <div class="grp">
        <div class="title">Ch·ªçn nhanh (nguy√™n nh√°nh)</div>
        ${basic.map(b => `
          <label class="item"><input type="checkbox" class="pick" value="${b.key}" checked>
          <div><b>${b.label}</b><div style="font-size:12px;color:#666">${b.desc}</div></div></label>
        `).join('')}
      </div>

      <div class="grp">
        <div class="title">Ph·∫ßn m·ªÅm (HKCU\\Software)</div>
        <input id="srch1" placeholder="T√¨m theo t√™n..." style="width:100%;margin:4px 0 8px 0;padding:6px 8px">
        <div id="softList" class="cols">
          ${soft.map(s => `
            <label class="item"><input type="checkbox" class="pick" value="reg:${s.Path}">
            <div>${s.Name}</div></label>`).join('')}
        </div>
      </div>

      <div class="grp">
        <div class="title">T√πy ch·ªânh c√° nh√¢n (Control Panel ‚Äî c√≥ n√¢ng cao)</div>
        <div class="cols">
          ${cps.map(s => `
            <label class="item"><input type="checkbox" class="pick" value="reg:${s.Path}">
            <div>${s.Name}</div></label>`).join('')}
        </div>
      </div>

      <p style="color:#d9534f;font-size:13px">
        <b>C·∫£nh b√°o:</b> Kh√¥i ph·ª•c n√™n th·ª±c hi·ªán tr√™n c√πng m√°y & phi√™n b·∫£n Windows ƒë·ªÉ tr√°nh l·ªói h·ªá th·ªëng.
      </p>
      <script>
        const inp = document.getElementById('srch1');
        const list = document.getElementById('softList');
        inp?.addEventListener('input', () => {
          const q = (inp.value || '').toLowerCase().trim();
          Array.from(list.querySelectorAll('.item')).forEach(li=>{
            const t = li.textContent.toLowerCase();
            li.style.display = (!q || t.includes(q)) ? '' : 'none';
          });
        });
      <\/script>
    `;

    const pick = await Swal.fire({
      title:'Ch·ªçn c√°c ph·∫ßn Registry c·∫ßn sao l∆∞u',
      html: renderList(),
      width: 780,
      focusConfirm: false,
      showCancelButton: true,
      confirmButtonText: 'B·∫Øt ƒë·∫ßu sao l∆∞u',
      cancelButtonText: 'H·ªßy',
      preConfirm: () => {
        const chosen = Array.from(Swal.getPopup().querySelectorAll('.pick'))
          .filter(c => c.checked)
          .map(c => c.value);
        if (!chosen.length) { Swal.showValidationMessage('H√£y ch·ªçn √≠t nh·∫•t 1 m·ª•c.'); }
        return chosen;
      }
    });
    if (!pick.isConfirmed) return;

    Swal.fire({ title:'ƒêang sao l∆∞u Registry‚Ä¶', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });
const r = await window.electronAPI.backupRegistry({ keys: pick.value, outputDir: outBase });
if (!r || !r.success) { Swal.fire('L·ªói', r?.message || 'Sao l∆∞u th·∫•t b·∫°i.', 'error'); return; }

const zipPath = r.ZipFile || r.zip;   // <‚Äî d√≤ng quan tr·ªçng
let html = `<div style="text-align:left;margin-bottom:8px">
  <b>ƒê√£ t·∫°o 1 g√≥i ZIP:</b><br><code style="font-size:13px">${zipPath || '(kh√¥ng x√°c ƒë·ªãnh)'}</code>
</div>`;


    Swal.fire({ icon:'success', title:'Ho√†n t·∫•t!', html, width:'820px' });
  } catch (e) {
    console.error(e);
    Swal.fire('L·ªói', 'ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.', 'error');
  }
});

  // === Kh√¥i ph·ª•c D·ªØ li·ªáu ===

// === Kh√¥i ph·ª•c D·ªØ li·ªáu ===
(function () {
  const btn = document.getElementById('restore-data-btn');
  if (!btn) return;

  function ensureBackupDir() {
    const v = document.getElementById('backup-folder')?.value?.trim();
    if (!v) {
      Swal.fire('Thi·∫øu th∆∞ m·ª•c sao l∆∞u','H√£y ch·ªçn "Th∆∞ m·ª•c sao l∆∞u backup" tr∆∞·ªõc.','warning');
      return null;
    }
    return v;
  }

  btn.addEventListener('click', async () => {
    try {
      const baseDir = ensureBackupDir(); if (!baseDir) return;

      Swal.fire({ title:'ƒêang qu√©t g√≥i sao l∆∞u‚Ä¶', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });

      const catalog = await window.electronAPI.restoreList({ baseDir });
      if (!catalog?.success) {
        Swal.fire('L·ªói', catalog?.message || 'Kh√¥ng th·ªÉ qu√©t th∆∞ m·ª•c backup.', 'error');
        return;
      }

      const items = catalog.items || [];
      if (!items.length) {
        Swal.fire('Kh√¥ng t√¨m th·∫•y g√≥i', 'Th∆∞ m·ª•c backup kh√¥ng c√≥ t·ªáp n√†o c√≥ th·ªÉ kh√¥i ph·ª•c.', 'info');
        return;
      }

      // Render danh s√°ch g√≥i ƒë·ªÉ ch·ªçn
      const html = `
        <div style="text-align:left;max-height:48vh;overflow:auto">
          ${items.map((it) => {
            const dis = it.restorable ? '' : 'disabled';
            const note = it.restorable ? '' : ' <em style="color:#666">(kh√¥ng th·ªÉ kh√¥i ph·ª•c)</em>';
            return `
              <div style="margin:.35rem 0">
                <label style="display:flex;gap:.5rem;align-items:center">
                  <input type="checkbox" value="${it.id}" ${dis}/>
                  <div>
                    <div><b>${it.label}</b>${note}</div>
                    <div style="font-size:12px;color:#555">${it.sourceName}</div>
                    ${it.targetHint ? `<div style="font-size:12px;color:#777">‚Üí ${it.targetHint}</div>` : ''}
                  </div>
                </label>
              </div>`;
          }).join('')}
        </div>`;

      const pick = await Swal.fire({
        title: 'Ch·ªçn g√≥i c·∫ßn kh√¥i ph·ª•c',
        html, width: '800px', focusConfirm: false,
        showCancelButton: true, confirmButtonText: 'B·∫Øt ƒë·∫ßu', cancelButtonText: 'H·ªßy',
        preConfirm: () => {
          const chosen = Array.from(Swal.getPopup().querySelectorAll('input[type=checkbox]'))
            .filter(c => c.checked).map(c => c.value);
          if (!chosen.length) { Swal.showValidationMessage('H√£y ch·ªçn √≠t nh·∫•t 1 g√≥i.'); }
          return chosen;
        }
      });
      if (!pick.isConfirmed) return;

      // === N·∫øu c√≥ g√≥i Registry, h·ªèi chi ti·∫øt c√°c file .REG c·∫ßn kh√¥i ph·ª•c ===
      const chosenIds = pick.value;
      const regSelections = {}; // { [id]: ['Mouse.reg','7-Zip.reg', ...] }

      for (const id of chosenIds) {
        const it = items.find(x => x.id === id);
        if (!it || it.kind !== 'registry') continue;

        const resp = await window.electronAPI.registryZipEntries({ zipPath: it.source });
        const entries = (resp?.entries || []).map(e => e.Name);
        if (!entries.length) continue;

        if (entries.length > 1) {
          const htmlPickRegs = `
            <div style="text-align:left;max-height:45vh;overflow:auto">
              ${entries.map(n => `
                <label style="display:block;margin:.25rem 0">
                  <input type="checkbox" class="pick-reg" value="${n}" checked> <code>${n}</code>
                </label>`).join('')}
            </div>`;
          const sel = await Swal.fire({
            title: `Ch·ªçn file .REG trong "${it.sourceName}"`,
            html: htmlPickRegs, width: 720, focusConfirm: false,
            showCancelButton: true, confirmButtonText: 'Ti·∫øp t·ª•c', cancelButtonText: 'H·ªßy',
            preConfirm: () => {
              const picked = Array.from(Swal.getHtmlContainer().querySelectorAll('.pick-reg:checked'))
                .map(x => x.value);
              if (!picked.length) { Swal.showValidationMessage('H√£y ch·ªçn √≠t nh·∫•t 1 file .reg.'); return false; }
              return picked;
            }
          });
          if (!sel.isConfirmed) return; // ng∆∞·ªùi d√πng h·ªßy
          regSelections[id] = sel.value;
        } else {
          // Ch·ªâ c√≥ 1 file th√¨ t·ª± ƒë·ªông ch·ªçn
          regSelections[id] = entries;
        }
      }

      // G·ªçi kh√¥i ph·ª•c, g·ª≠i k√®m regSelections
      Swal.fire({ title:'ƒêang kh√¥i ph·ª•c‚Ä¶', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });
      const r = await window.electronAPI.restoreRun({ baseDir, ids: chosenIds, regSelections });

      if (!r?.success) {
        Swal.fire('L·ªói', r?.message || 'Kh√¥i ph·ª•c th·∫•t b·∫°i.', 'error');
        return;
      }

      // K·∫øt qu·∫£ tr·∫£ v·ªÅ l√† m·∫£ng c√°c item
      const resItems = Array.isArray(r.results) ? r.results : [];

      // Ti·ªán √≠ch render chi ti·∫øt cho m·ª•c Registry
      const renderRegistryDetail = (it) => {
        if (it?.kind !== 'registry') return '';
        const ok   = Array.isArray(it.regOk)   ? it.regOk   : [];
        const fail = Array.isArray(it.regFail) ? it.regFail : [];
        let html = '';
        if (ok.length) {
          html += `<div style="margin:6px 0 0 18px">
            <b>ƒê√£ import:</b><br>${ok.map(n => `<code style="font-size:12px">${n}</code>`).join('<br>')}
          </div>`;
        }
        if (fail.length) {
          html += `<div style="margin:6px 0 0 18px;color:#b91c1c">
            <b>L·ªói:</b><br>${
              fail.map(e => `<code style="font-size:12px">${e.Name || ''}</code>${e.Message ? (' ‚Äî ' + e.Message) : ''}`).join('<br>')
            }
          </div>`;
        }
        return html;
        };

      const ok = resItems.filter(x => x?.success);
      const fail = resItems.filter(x => !x?.success);

      let htmlDone = '';
      if (ok.length) {
        htmlDone += `<div style="text-align:left"><b>Th√†nh c√¥ng:</b><ul>${
          ok.map(x => `
            <li>
              ${x.label}
              ${x.kind === 'registry'
                ? renderRegistryDetail(x)
                : (x.target ? ` ‚Üí <code>${x.target}</code>` : '')}
            </li>`
          ).join('')}
        </ul></div>`;
      }
      if (fail.length) {
        htmlDone += `<div style="text-align:left;color:#b91c1c"><b>Th·∫•t b·∫°i:</b><ul>${
          fail.map(x => `
            <li>
              ${x.label}
              ${x.kind === 'registry' ? renderRegistryDetail(x) : ''}
              ${x.message ? ` ‚Äî ${x.message}` : ''}
            </li>`
          ).join('')}
        </ul></div>`;
      }

      Swal.fire({
        icon: fail.length ? 'warning' : 'success',
        title: 'Ho√†n t·∫•t!',
        html: htmlDone || 'ƒê√£ kh√¥i ph·ª•c.',
        width: '820px'
      });

    } catch (err) {
      console.error(err);
      Swal.fire('L·ªói', String(err?.message || err), 'error');
    }
  });
})();
</script>
</body>
</html>